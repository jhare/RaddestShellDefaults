/**
 * Functions for managing whitelist and blacklist
 *
 * @author              Warren Benedetto <warren@transfusionmedia.com>
 * @since               January 16, 2010
 * @version             1.0.0
 */var ListManager=function(){return{blacklist:{},whitelist:{},init:function(){this.loadBlacklist(),this.loadWhitelist(),this.isSyncDisabled()||this.addSyncChangeListener()},isSyncDisabled:function(){return this.getLocal("disableSync")==="true"},addSyncChangeListener:function(){var e=this;chrome.storage.onChanged.addListener(function(t,n){console.log(n+" storage changed",t),e.loadBlacklist(),e.loadWhitelist()})},loadBlacklist:function(e){if(this.isSyncDisabled()){var t=this.getLocal("blacklist");this.onBlacklistLoaded(JSON.parse(t)),typeof e=="function"&&e()}else{var n=this;this.getSynced("blacklist",function(t){n.onBlacklistLoaded(t),typeof e=="function"&&e()})}},onBlacklistLoaded:function(e){if(typeof e!="object"||e===null)e={};typeof e[""]=="object"&&(delete e[""],this.blacklist=e,this.saveBlacklist()),this.blacklist=e.sort()},saveBlacklist:function(){this.isSyncDisabled()?this.setLocal("blacklist",JSON.stringify(this.blacklist.sort())):this.setSynced({blacklist:this.blacklist.sort()})},addToBlacklist:function(e){return e.indexOf("stayfocusd")>=0?(alert(chrome.i18n.getMessage("cannotBlockStayFocusd")),!1):(this.removeFromWhitelist(e),this.blacklist[e]={},this.blacklist=this.cleanUpList(e,this.blacklist),this.saveBlacklist(),StayFocusd.checkURL(),!0)},removeFromBlacklist:function(e){return this.isBlacklisted(e)&&StayFocusd.isMaxTimeAllowedExceeded()?(alert(chrome.i18n.getMessage("cannotRemoveSiteOnceTimeIsUp")),!1):(delete this.blacklist[e],this.saveBlacklist(),StayFocusd.checkURL(),!0)},clearBlacklist:function(){if(StayFocusd.isMaxTimeAllowedExceeded())return alert(chrome.i18n.getMessage("cannotClearBlockedSitesOnceTimeIsUp")),!1;this.blacklist={},this.setSynced({blacklist:this.blacklist})},getBlacklistedDomains:function(){var e=[];for(var t in this.blacklist)this.blacklist.hasOwnProperty(t)&&e.push(t);return e},loadWhitelist:function(e){if(this.isSyncDisabled()){var t=this.getLocal("whitelist");this.onWhitelistLoaded(JSON.parse(t)),typeof e=="function"&&e()}else{var n=this;this.getSynced("whitelist",function(t){n.onWhitelistLoaded(t),typeof e=="function"&&e()})}},onWhitelistLoaded:function(e){if(typeof e!="object"||e===null)e={};typeof e[""]=="object"&&(delete e[""],this.whitelist=e,this.saveWhitelist()),this.whitelist=e.sort()},saveWhitelist:function(){this.isSyncDisabled()?this.setLocal("whitelist",JSON.stringify(this.whitelist.sort())):this.setSynced({whitelist:this.whitelist.sort()})},addToWhitelist:function(e){if(StayFocusd.isMaxTimeAllowedExceeded()){if(this.isBlacklisted(e))return alert(chrome.i18n.getMessage("cannotAllowBlockedSiteOnceTimeIsUp")),!1;if(e.indexOf("*")>-1)return alert(chrome.i18n.getMessage("cannotAllowSitesUsingWildcardsOnceTimeIsUp")),!1}return NuclearOption.isActive()?(alert(chrome.i18n.getMessage("cannotAddAllowedSitesDuringNuclearOption")),!1):(this.removeFromBlacklist(e),this.whitelist[e]={},this.whitelist=this.cleanUpList(e,this.whitelist),this.saveWhitelist(),StayFocusd.checkURL(),!0)},removeFromWhitelist:function(e){return delete this.whitelist[e],this.saveWhitelist(),StayFocusd.checkURL(),!0},clearWhitelist:function(){if(NuclearOption.isActive())return alert(chrome.i18n.getMessage("cannotClearAllowedSitesDuringNuclearOption")),!1;this.whitelist={},this.setSynced({whitelist:this.whitelist})},getWhitelistedDomains:function(){var e=[];for(var t in this.whitelist)this.whitelist.hasOwnProperty(t)&&e.push(t);return e},isBlacklisted:function(e){return this.isListed(e,"black")},isWhitelisted:function(e){return this.isListed(e,"white")},isListed:function(e,t){return this.getMatchFromList(e,t)!==!1},getMatchFromList:function(e,t){var n=t=="white"?this.whitelist:this.blacklist;for(var r in n)if(n.hasOwnProperty(r)){var i=/^[a-z0-9]+$/i;if(i.test(r)&&typeof n[r]=="function")continue;if(DomainParser.isMoreGeneralURL(r,e))return r;if(r.indexOf("*")===0&&DomainParser.matchesWildcard(r,e))return r}return!1},cleanUpList:function(e,t){var n={};for(var r in t)if(t.hasOwnProperty(r)){var i=!1;for(var s in n)n.hasOwnProperty(s)&&(r==s||DomainParser.isMoreGeneralURL(s,r))&&(i=!0);if(i===!0)continue;DomainParser.isMoreGeneralURL(e,r)?n[e]={}:r!=undefined&&r!=null&&r!=""&&(n[r]={})}return n},mergeLocalWithSynced:function(e){var t=this.getLocal("blacklist"),n=this.getLocal("whitelist"),r=JSON.parse(t)||{},i=JSON.parse(n)||{},s=this;this.getSynced("blacklist",function(t){var n=t||{};for(var i in r)r.hasOwnProperty(i)&&(n[i]=r[i]);s.setSynced({blacklist:n}),s.loadBlacklist(e)}),this.getSynced("whitelist",function(t){var n=t||{};for(var r in i)i.hasOwnProperty(r)&&(n[r]=i[r]);s.setSynced({whitelist:n}),s.loadWhitelist(e)})},setSynced:function(e){chrome.storage.sync.set(e,function(){});for(var t in e)e.hasOwnProperty(t)&&this.setLocal("sync_"+t,JSON.stringify(e[t]))},getSynced:function(e,t){var n=this;return chrome.storage.sync.get(e,function(r){if(typeof r=="undefined"){var i=n.getLocal("sync_"+e);r={},r[e]=JSON.parse(i)||{}}t(r[e])})},removeSynced:function(e){return this.removeLocal("sync_"+e),chrome.storage.sync.remove(e,function(){})},setLocal:function(e,t){localStorage.setItem(e,t)},getLocal:function(e){return localStorage.getItem(e)},removeLocal:function(e){return localStorage.removeItem(e)}}}();Object.prototype.sort=function(){var e=[],t={};for(var n in this)this.hasOwnProperty(n)&&e.push(n);e.sort();for(var r=0;r<e.length;r++){var i=e[r];t[i]=this[i]}return t};